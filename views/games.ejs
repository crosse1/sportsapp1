<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body class="d-flex flex-column min-vh-100 gradient-bg">
  <%- include('partials/header') %>

  <div class="container my-4 flex-grow-1">
    <form class="row g-3 mb-4 position-relative" method="get" action="/games">
      <div class="col-sm-5 position-relative">
        <input id="teamInput" type="text" class="form-control" name="team" placeholder="Search by team" autocomplete="off" value="<%= filters.team || '' %>">
        <div id="teamSuggestions" class="list-group team-suggestions"></div>
      </div>
      <div class="col-sm-5">
        <input type="date" class="form-control" name="date" value="<%= filters.date || '' %>">
      </div>
      <div class="col-sm-2 d-grid">
        <button type="submit" class="btn btn-primary">Filter</button>
      </div>
    </form>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% games.forEach(function(game){ %>
        <div class="col">
          <div class="card shadow-sm h-100 game-card p-3 text-center" style="background: linear-gradient(to right, <%= game.awayTeam && game.awayTeam.color ? game.awayTeam.color : '#ffffff' %>, <%= game.homeTeam && game.homeTeam.color ? game.homeTeam.color : '#ffffff' %>);">
            <div class="fw-bold mb-2" data-start="<%= game.startDate.toISOString() %>"></div>
            <div class="d-flex align-items-center justify-content-center mb-2">
              <div class="me-3 text-center">
                <img loading="lazy" class="team-logo mb-1" src="<%= game.awayTeam && game.awayTeam.logos && game.awayTeam.logos[0] ? game.awayTeam.logos[0] : 'https://via.placeholder.com/60' %>" alt="<%= game.awayTeamName %>">
                <div class="small"><%= game.awayTeamName %></div>
              </div>
              <div class="fw-bold fs-4">@</div>
              <div class="ms-3 text-center">
                <img loading="lazy" class="team-logo mb-1" src="<%= game.homeTeam && game.homeTeam.logos && game.homeTeam.logos[0] ? game.homeTeam.logos[0] : 'https://via.placeholder.com/60' %>" alt="<%= game.homeTeamName %>">
                <div class="small"><%= game.homeTeamName %></div>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.querySelectorAll('[data-start]').forEach(function(el){
        var date = new Date(el.dataset.start);
        el.textContent = new Intl.DateTimeFormat(navigator.language, { dateStyle: 'medium', timeStyle: 'short' }).format(date);
      });

      const teamInput = document.getElementById('teamInput');
      const suggestions = document.getElementById('teamSuggestions');
      if(teamInput){
        teamInput.addEventListener('input', async function(){
          const q = this.value.trim();
          if(!q){ suggestions.innerHTML=''; return; }
          const res = await fetch('/teams/search?q='+encodeURIComponent(q));
          if(!res.ok) return;
          const data = await res.json();
          suggestions.innerHTML = data.map(t=>`<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-name="${t.school}">`+
            `<img src="${t.logos && t.logos[0] ? t.logos[0] : 'https://via.placeholder.com/30'}">`+
            `${t.school}</button>`).join('');
        });

        suggestions.addEventListener('click', function(e){
          const btn = e.target.closest('button[data-name]');
          if(!btn) return;
          const name = btn.getAttribute('data-name');
          teamInput.value = name;
          suggestions.innerHTML='';
          const params = new URLSearchParams(window.location.search);
          params.set('team', name);
          document.location.search = params.toString();
        });
      }
    </script>
</body>
</html>
