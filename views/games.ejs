<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Games</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body class="d-flex flex-column min-vh-100 gradient-bg">
  <%- include('partials/header') %>

  <div class="container my-4 flex-grow-1">
    <form class="row g-3 mb-4 position-relative" method="get" action="/games" id="filtersForm">
      <div class="col-sm-5 position-relative">
        <input id="teamInput" type="text" class="form-control" name="team" placeholder="Search by team" autocomplete="off" value="<%= filters.team || '' %>">
        <input type="hidden" id="teamId" name="teamId" value="<%= filters.teamId || '' %>">
        <div id="teamSuggestions" class="list-group team-suggestions"></div>
      </div>
      <div class="col-sm-5">
        <input type="date" class="form-control" name="date" value="<%= filters.date || '' %>">
      </div>
      <div class="col-sm-2 d-grid">
        <button type="submit" class="btn btn-primary">Filter</button>
      </div>
      <input type="hidden" id="latInput" name="lat" value="<%= filters.lat || '' %>">
      <input type="hidden" id="lngInput" name="lng" value="<%= filters.lng || '' %>">
      <div class="col-12 d-flex align-items-center gap-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="sortProximity" <%= filters.sort !== 'time' ? 'checked' : '' %>>
          <label class="form-check-label" for="sortProximity">Sort by Proximity</label>
        </div>
        <div class="flex-grow-1">
          <label for="radiusRange" class="form-label">Show games within <span id="radiusVal"><%= filters.radius %></span> miles</label>
          <input type="range" class="form-range" min="10" max="500" step="10" id="radiusRange" value="<%= filters.radius %>">
        </div>
      </div>
    </form>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="gamesContainer">
      <% games.forEach(function(game){
           const awayColor = game.awayTeam && game.awayTeam.color ? game.awayTeam.color : '#ffffff';
           const homeColor = game.homeTeam && game.homeTeam.color ? game.homeTeam.color : '#ffffff';
      %>
    <div class="col" data-distance="<%= typeof game.distance === 'number' ? game.distance.toFixed(1) : '' %>" data-start="<%= game.startDate.toISOString() %>">
          <a href="/games/<%= game._id %>" class="game-link">
            <div class="card shadow-sm h-100 game-card p-3 text-center position-relative" data-away-color="<%= awayColor %>" data-home-color="<%= homeColor %>" style="background: linear-gradient(to right, <%= awayColor %>, <%= homeColor %>);">
              <div class="game-date mb-2" data-start="<%= game.startDate.toISOString() %>"></div>
              <div class="d-flex justify-content-between align-items-center position-relative mb-2 px-3">
                <div class="logo-wrapper me-3">
                  <div class="team-logo-container">
                    <img loading="lazy" src="<%= game.awayTeam && game.awayTeam.logos && game.awayTeam.logos[0] ? game.awayTeam.logos[0] : 'https://via.placeholder.com/60' %>" alt="<%= game.awayTeamName %>">
                  </div>
                  <span class="team-name"><%= game.awayTeamName %></span>
                </div>
                <div class="logo-wrapper ms-3">
                  <div class="team-logo-container">
                    <img loading="lazy" src="<%= game.homeTeam && game.homeTeam.logos && game.homeTeam.logos[0] ? game.homeTeam.logos[0] : 'https://via.placeholder.com/60' %>" alt="<%= game.homeTeamName %>">
                  </div>
                  <span class="team-name"><%= game.homeTeamName %></span>
                </div>
                <div class="position-absolute top-50 start-50 translate-middle fw-bold fs-4 at-symbol">@</div>
              </div>
              <% if(typeof game.distance === 'number'){ %>
                <span class="badge bg-success near-badge"><%= game.distance.toFixed(0) %> mi</span>
              <% } %>
            </div>
          </a>
        </div>
      <% }); %>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.querySelectorAll('.game-date[data-start]').forEach(function(el){
        var date = new Date(el.dataset.start);
        el.textContent = new Intl.DateTimeFormat(navigator.language, { dateStyle: 'medium', timeStyle: 'short' }).format(date);
      });

      const teamInput = document.getElementById('teamInput');
      const suggestions = document.getElementById('teamSuggestions');
      if(teamInput){
        teamInput.addEventListener('input', async function(){
          document.getElementById('teamId').value = '';
          const q = this.value.trim();
          if(!q){ suggestions.innerHTML=''; return; }
          const res = await fetch('/teams/search?q='+encodeURIComponent(q));
          if(!res.ok) return;
          const data = await res.json();
          suggestions.innerHTML = data.map(t=>`<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-name="${t.school}" data-id="${t._id}">`+
            `<img src="${t.logos && t.logos[0] ? t.logos[0] : 'https://via.placeholder.com/30'}">`+
            `${t.school}</button>`).join('');
        });

        suggestions.addEventListener('click', function(e){
          const btn = e.target.closest('button[data-name]');
          if(!btn) return;
          const name = btn.getAttribute('data-name');
          const id = btn.getAttribute('data-id');
          teamInput.value = name;
          document.getElementById('teamId').value = id;
          suggestions.innerHTML='';
          const params = new URLSearchParams(window.location.search);
          params.set('teamId', id);
          params.set('team', name);
          document.location.search = params.toString();
        });
      }

      function hexToRgb(hex){
        if(!hex) return [255,255,255];
        hex = hex.replace('#','');
        if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
        const num = parseInt(hex,16);
        return [(num>>16)&255,(num>>8)&255,num&255];
      }

      function luminance(r,g,b){
        const a=[r,g,b].map(v=>{
          v/=255;
          return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4);
        });
        return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
      }

      function chooseTextColor(colors){
        const lums = colors.map(c=>{
          const [r,g,b] = hexToRgb(c);
          return luminance(r,g,b);
        });
        const avg = lums.reduce((a,b)=>a+b,0)/lums.length;
        return avg > 0.5 ? '#333333' : '#ffffff';
      }

      document.querySelectorAll('.game-card').forEach(card=>{
        const away = card.dataset.awayColor;
        const home = card.dataset.homeColor;
        const textColor = chooseTextColor([away, home]);
        card.querySelectorAll('.game-date, .team-name').forEach(el=>{
          el.style.color = textColor;
        });
      });

      const GEO_KEY = 'userCoords';
      const latInput = document.getElementById('latInput');
      const lngInput = document.getElementById('lngInput');

      function getCached(){
        try{
          const data = JSON.parse(localStorage.getItem(GEO_KEY));
          if(!data) return null;
          if(Date.now() - data.t > 30*60*1000) return null;
          return data;
        }catch(e){ return null; }
      }

      function saveCoords(lat,lng){
        localStorage.setItem(GEO_KEY, JSON.stringify({lat,lng,t:Date.now()}));
        if(window.loggedInUser){
          fetch('/profile/location',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({latitude:lat, longitude:lng})});
        }
      }

      async function ensureCoords(){
        let c = getCached();
        if(c) return c;
        if(!navigator.geolocation) return null;
        return new Promise(res=>{
          navigator.geolocation.getCurrentPosition(p=>{
            c = {lat:p.coords.latitude,lng:p.coords.longitude};
            saveCoords(c.lat,c.lng);
            res(c);
          }, ()=>res(null));
        });
      }

      ensureCoords().then(coords=>{
        if(coords){
          latInput.value = coords.lat;
          lngInput.value = coords.lng;
        }
      });

      const container = document.getElementById('gamesContainer');
      const cards = Array.from(container.children);
      const sortToggle = document.getElementById('sortProximity');
      const radiusRange = document.getElementById('radiusRange');
      const radiusVal = document.getElementById('radiusVal');

      function filterRadius(){
        const r = parseFloat(radiusRange.value);
        cards.forEach(card=>{
          const d = parseFloat(card.dataset.distance);
          if(!isNaN(d) && d > r){
            card.classList.add('d-none');
          }else{
            card.classList.remove('d-none');
          }
        });
      }

      function sortCards(){
        const sorted = cards.sort((a,b)=>{
          if(sortToggle.checked){
            const d1 = parseFloat(a.dataset.distance) || Infinity;
            const d2 = parseFloat(b.dataset.distance) || Infinity;
            if(d1 === d2){
              return new Date(a.dataset.start) - new Date(b.dataset.start);
            }
            return d1 - d2;
          }
          return new Date(a.dataset.start) - new Date(b.dataset.start);
        });
        container.classList.add('fading');
        setTimeout(()=>{
          sorted.forEach(el=>container.appendChild(el));
          container.classList.remove('fading');
          filterRadius();
        },150);
      }

      sortToggle.addEventListener('change', sortCards);
      radiusRange.addEventListener('input', ()=>radiusVal.textContent = radiusRange.value);
      radiusRange.addEventListener('change', filterRadius);

      sortCards();

    </script>
</body>
</html>
