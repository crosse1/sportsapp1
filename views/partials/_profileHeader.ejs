<style>
  /* === Profile Header: unified, page-agnostic styles === */
  .profile-header .profile-avatar-wrapper {
    position: relative;
    width: clamp(120px, 20vw, 200px);
    height: clamp(120px, 20vw, 200px);
  }

  .profile-header .profile-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.8);
    display: block;
  }

  .profile-header .chain-logo {
    position: absolute;
    width: 42px;
    height: 42px;
    display: inline-block;
    transform: translateZ(0);
  }

  .profile-header .chain-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #fff;
    background: #fff;
    display: block;
  }

  .profile-header .profile-identity {
    gap: 0.5rem;
  }

  .profile-header .profile-identity h2 {
    font-size: clamp(1.75rem, 3vw, 2.5rem);
    letter-spacing: -0.02em;
  }

  .profile-header .profile-divider {
    opacity: 0.6;
    font-weight: 600;
  }

  .profile-header .user-points {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .profile-header .profile-follow-stats a {
    color: inherit;
  }

  .profile-header .profile-follow-stats small {
    letter-spacing: 0.02em;
  }

  .profile-header .profile-actions .btn {
    min-width: 170px;
  }

  .glassy-btn.btn-primary,
  .glassy-btn.btn-secondary {
    background: linear-gradient(to right, #14b8a6, #7e22ce);
    border: 1px solid rgba(255, 255, 255, 0.35);
    color: #fff;
  }

  .glassy-btn.btn-secondary {
    opacity: 0.85;
  }

  @media (max-width: 767.98px) {
    .profile-header .profile-identity {
      justify-content: center !important;
      text-align: center;
    }

    .profile-header .profile-follow-stats {
      justify-content: center;
    }

    .follow-users-btn,
    .add-game-btn,
    .profile-actions .btn {
      width: 100%;
      max-width: 320px;
    }
  }

  .search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    backdrop-filter: blur(10px);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
  }

  .suggestion-item {
    padding: 0.5rem;
    font-weight: 700;
    color: #fff;
  }

  .suggestion-item:hover {
    background: linear-gradient(to right, #14b8a6, #7e22ce);
  }
</style>
<%
  const profileSlug = user && (user.venmo || user._id);
  const resolvedActiveTab = typeof activeTab === 'string' ? activeTab : 'stats';
  const pointsDisplay = (user.points || 0).toLocaleString();
  const inlineTabsEnabled = typeof useInlineTabs === 'boolean' ? useInlineTabs : false;
  const navItems = [
    { key: 'stats', label: 'Stats', target: '#stats' },
    { key: 'games', label: 'Games', target: '#gamesTab' },
    { key: 'badges', label: 'Badges', target: '#badges' },
    { key: 'waitlist', label: 'Waitlist', target: '#wishlist' }
  ];
%>
<div class="profile-header pt-5 pb-0 text-white">
  <div class="container">
    <div class="row align-items-center g-4">
      <div class="col-lg-3 col-md-4 text-center mb-3 mb-md-0">
        <div class="profile-avatar-wrapper d-inline-block">
          <img src="/users/<%= user._id %>/profile-image" class="avatar avatar-lg profile-avatar" alt="Profile Photo">
          <% if (user.favoriteTeams && user.favoriteTeams.length > 0) { %>
            <% user.favoriteTeams.forEach(function(t){ %>
              <% const teamLogo = t.logos && t.logos[0] ? t.logos[0] : '/images/placeholder.jpg'; %>
              <a href="/profile/<%= profileSlug %>/<%= t._id %>" class="chain-logo" title="<%= t.school %>">
                <img src="<%= teamLogo %>" alt="<%= t.school %>">
              </a>
            <% }) %>
          <% } %>
        </div>
      </div>

      <div class="col-lg-6 col-md-8 text-center text-md-start">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-start profile-identity mb-2">
          <h2 class="fw-bold mb-0">@<%= user.username %></h2>
          <span class="profile-divider d-none d-sm-inline">|</span>
          <div class="user-points">
            <span aria-hidden="true">ðŸ’Ž</span>
            <span><%= pointsDisplay %></span>
          </div>
          <% if (isCurrentUser) { %>
            <a href="/profile/edit" class="btn glassy-btn btn-sm edit-profile-btn ms-md-2 d-none d-md-inline-flex">Edit Profile</a>
          <% } else if (canMessage) { %>
            <button class="btn glassy-btn btn-sm message-btn ms-md-2 d-none d-md-inline-flex" data-user="<%= user._id %>">Message</button>
          <% } %>
        </div>

        <% if (!isCurrentUser && canMessage) { %>
          <div class="d-flex d-md-none justify-content-center mb-3">
            <button class="btn glassy-btn btn-sm message-btn w-100" data-user="<%= user._id %>">Message</button>
          </div>
        <% } else if (isCurrentUser) { %>
          <div class="d-flex d-md-none justify-content-center mb-3">
            <a href="/profile/edit" class="btn glassy-btn btn-sm w-100">Edit Profile</a>
          </div>
        <% } %>

        <div class="d-flex profile-follow-stats justify-content-center justify-content-md-start pb-2 gap-4">
          <div>
            <a href="/users/<%= user._id %>/followers" class="text-decoration-none text-white">
              <div id="followersCount" class="fw-bold"><%= user.followersCount %></div>
              <small class="text-white-50">Followers</small>
            </a>
          </div>
          <div>
            <a href="/users/<%= user._id %>/following" class="text-decoration-none text-white">
              <div class="fw-bold"><%= user.followingCount %></div>
              <small class="text-white-50">Following</small>
            </a>
          </div>
        </div>

        <% if (isCurrentUser) { %>
          <div class="mt-3 d-flex flex-column align-items-center gap-2 gap-md-0 flex-md-row">
            <button id="openUserModal" class="btn glassy-btn rounded-pill follow-users-btn px-4" data-bs-toggle="modal" data-bs-target="#userSearchModal">Follow Users</button>
            <button id="addGameBtn" type="button" class="btn glassy-btn add-game-btn mt-2 mt-md-0 ms-md-3" data-bs-toggle="modal" data-bs-target="#addGameModal">+ Game</button>
          </div>
        <% } %>
      </div>

      <div class="col-lg-3 text-center text-lg-end profile-actions">
        <% if (isCurrentUser) { %>
          <a href="/profile/edit" class="btn glassy-btn rounded-pill px-4">Edit Profile</a>
        <% } else if (viewer) { %>
          <button id="followBtn" data-user="<%= user._id %>" class="btn glassy-btn rounded-pill px-4 follow-btn <%= isFollowing ? 'btn-secondary' : 'btn-primary' %>"><%= isFollowing ? 'Following' : 'Follow' %></button>
        <% } %>
      </div>
    </div>
  </div>

  <div class="container mt-4 pb-0">
    <ul class="nav nav-tabs profile-tabs" id="profileTabs" role="tablist">
      <% navItems.forEach(function(item) { %>
        <% const isActive = resolvedActiveTab === item.key; %>
        <li class="nav-item" role="presentation">
          <% if (inlineTabsEnabled) { %>
            <button
              class="nav-link profile-tab <%= isActive ? 'active' : '' %>"
              id="<%= item.key %>-tab"
              data-bs-toggle="tab"
              data-bs-target="<%= item.target %>"
              type="button"
              role="tab"
              aria-controls="<%= item.target.replace('#', '') %>"
              aria-selected="<%= isActive ? 'true' : 'false' %>"
            ><%= item.label %></button>
          <% } else { %>
            <a
              href="/profile/<%= profileSlug %>/<%= item.key %>"
              class="nav-link profile-tab <%= isActive ? 'active' : '' %>"
            ><%= item.label %></a>
          <% } %>
        </li>
      <% }) %>
    </ul>
  </div>
</div>

<% if (isCurrentUser) { %>
  <div class="modal fade user-search-modal" id="userSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title">Find Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="position-relative mb-3 profile-search-wrapper w-100">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control profile-search" autocomplete="off">
            <div id="loadingSpinner" class="spinner-border spinner-border-sm text-light position-absolute end-0 top-50 translate-middle-y me-3 d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div id="searchDropdown" class="search-dropdown d-none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } %>
